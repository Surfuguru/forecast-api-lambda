name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install Python dependencies
        run: |
          pip install tomli-w
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Install SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
      
      - name: Build Lambda layer
        run: |
          mkdir -p layer/pymysql/python
          pip install -r layer/pymysql/requirements.txt -t layer/pymysql/python
      
      - name: Build SAM application
        run: |
          cd infrastructure
          sam build
      
      - name: Generate SAM config
        env:
          DB_HOST: ${{ secrets.FORECAST_API_MYSQL_HOST }}
          DB_USER: ${{ secrets.FORECAST_API_MYSQL_USER }}
          DB_PASSWORD: ${{ secrets.FORECAST_API_MYSQL_PASSWORD }}
          DB_NAME: ${{ secrets.FORECAST_API_MYSQL_DATABASE }}
          S3_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          S3_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ vars.FORECAST_BUCKET }}
        run: |
          cd infrastructure
          python3 << 'PYTHON'
          import os
          import tomli_w
          
          def escape_toml_string(s):
              """Escape a string for TOML format"""
              if not s:
                  return '""'
              # Escape backslashes first, then quotes
              s = s.replace('\\', '\\\\')
              s = s.replace('"', '\\"')
              return f'"{s}"'
          
          # Build parameter_overrides string
          params = [
              f"Environment=\"production\"",
              f"DbHost={escape_toml_string(os.environ.get('DB_HOST', ''))}",
              f"DbUser={escape_toml_string(os.environ.get('DB_USER', ''))}",
              f"DbPassword={escape_toml_string(os.environ.get('DB_PASSWORD', ''))}",
              f"DbName={escape_toml_string(os.environ.get('DB_NAME', ''))}",
              f"S3AccessKeyId={escape_toml_string(os.environ.get('S3_ACCESS_KEY', ''))}",
              f"S3SecretAccessKey={escape_toml_string(os.environ.get('S3_SECRET_KEY', ''))}",
              f"S3ForecastBucket={escape_toml_string(os.environ.get('S3_BUCKET', ''))}",
          ]
          
          config = {
              "version": 0.1,
              "default": {
                  "deploy": {
                      "parameters": {
                          "stack_name": "forecast-api-live",
                          "s3_bucket": "forecast-api-lambda-deployments",
                          "capabilities": ["CAPABILITY_IAM", "CAPABILITY_NAMED_IAM"],
                          "region": "us-east-1",
                          "confirm_changeset": False,
                          "fail_on_empty_changeset": False,
                          "parameter_overrides": " ".join(params)
                      }
                  }
              }
          }
          
          with open("samconfig.toml", "wb") as f:
              tomli_w.dump(config, f)
          
          # Print config for debugging (mask secrets)
          print("Generated samconfig.toml")
          PYTHON
      
      - name: Deploy to AWS
        run: |
          cd infrastructure
          sam deploy --config-file samconfig.toml
      
      - name: Get API Gateway URL
        id: api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name forecast-api-live \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $API_URL"
